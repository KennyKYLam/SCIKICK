<!DOCTYPE html>
<html>

<head>
    <title>Kenny Soccer Game</title>
    <script src="http://cdn.pubnub.com/pubnub-3.7.1.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="chatroom.css">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="wrapper">
        <div class="titlecot">
            <image src="ScikicLogo.svg" />
            <div class="initialButtons">

                <button id="startButton" class="btn btn-success" onclick="startClicked()">Start Round</button>
                <button id="statButton" class="btn btn-warning stats" onclick="stats()">View Stats</button>
                <div class="bulletin" id="bulletin">
                    Welcome to SCIKIK
                </div>

            </div>

        </div>
        <div id="questions" class="questions">
        </div>


        <div class="content">
            <svg id="game">
                <polyline points="50,196 50,5 500,5 500,196" style="fill:none;stroke:white;stroke-width:4" />
                <g id="targetCot">
                    <circle id="targeta" class="target" cx="100" cy="50" r="30" cursor="pointer" />
                    <text x="88" y="63" font-size="40px" pointer-events="none">A</text>

                    <circle id="targetb" class="target" cx="175" cy="150" r="30" cursor="pointer" />
                    <text x="163" y="163" font-size="40px" pointer-events="none">B</text>

                    <circle id="targetc" class="target" cx="450" cy="50" r="30" cursor="pointer" />
                    <text x="435" y="63" font-size="40px" pointer-events="none">C</text>

                    <circle id="targetd" class="target" cx="375" cy="150" r="30" cursor="pointer" />
                    <text x="363" y="163" font-size="40px" pointer-events="none">D</text>

                </g>
                <animateMotion xlink:href="#target" dur="10s" begin="click" fill="freeze">
                    <mpath xlink:href="#goaline" />
                </animateMotion>



                <g id="fieldplayer" transform="translate(155,240)">
                    <circle fill="#FFFFFF" stroke="#000000" stroke-width="4" stroke-miterlimit="10" cx="104.232" cy="38.124" r="29.796" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M46.842,91.803
	c33.357-6.747,57.389-14.992,57.389-14.992c35.188,8.62,57.301,8.995,57.301,8.995" />
                    <line fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" x1="103" y1="135" x2="103" y2="69" />
                    <g class="rightleg">
                        <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M38.387,107.332
	c10.494,18.479,21.008,37.079,29.628,38.579c8.62,1.5,33.985-9.665,33.985-9.665V135" />
                        <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M19.833,115.292c0,0,16.333-11.833,18.554-7.96" />
                        <animateTransform attributeType="XML" attributeName="transform" type="rotate" from="40,103,135" to="-140,103,135" begin="0s" dur="1s" repeatCount="indefinite" />
                    </g>
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M140.291,194.773c0-21.528-2.18-38.396-7.164-45.931
	c-4.982-7.536-29.709-13.069-29.709-13.069" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M141.291,194.773c0,4.932,19.725,1.785,19.725,1.785
	" />
                </g>
                <g id="goalie">
                    <circle fill="#FFFFFF" stroke="#000000" stroke-width="4" stroke-miterlimit="10" cx="101.197" cy="44.326" r="26.949" />
                    <line fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" x1="100" y1="71" x2="100" y2="127" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M101.367,127.072" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M101.367,74.055c0,0-40.317,12.028-42.353,7.797" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M101.367,74.055" />
                    <line fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" x1="164.789" y1="40.272" x2="143.428" y2="81.852" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M101.075,74.055c0,0,40.317,12.028,42.353,7.797" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M101.367,127.072c0,0-26.12,11.558-28.8,18.8" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M68.567,186.672c0-10.248,0.37-31.215,4-40.8" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M133.367,190.271c0-11.11-0.079-33.455-2-44.399" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M131.367,145.872c-1.628-9.399-30-18.8-30-18.8" />
                    <path fill="#FFFFFF" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M34.434,40.272c0,0-21.324,2.132-28.445-19.232
	C1.38,7.216,14.55,24.329,14.55,24.329S10.367,17.377,9.5,13.85c-3.029-12.327,10.466,6.622,10.466,6.622s-4.6-6.622-5.267-11.8
	c-1.138-8.838,9.891,8.705,9.891,8.705S21.706,13.391,22.21,5.91c0.854-12.657,12.957,17.562,12.957,17.562
	c2.594,2.696,1.417-13.36,6.208-13.695c3.615-0.252,3.615,15.634,2.794,20.125C43.279,34.768,39.967,38.206,34.434,40.272
	l24.489,41.565" />
                    <path fill="#FFFFFF" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M164.789,40.272c0,0,21.324,2.132,28.445-19.232
	c4.608-13.824-8.563,3.289-8.563,3.289s4.184-6.952,5.051-10.479c3.028-12.327-10.467,6.622-10.467,6.622s4.6-6.622,5.267-11.8
	c1.138-8.838-9.891,8.705-9.891,8.705s2.884-3.986,2.38-11.467c-0.854-12.657-12.956,17.562-12.956,17.562
	c-2.594,2.696-1.417-13.36-6.208-13.695c-3.614-0.252-3.614,15.634-2.793,20.125C155.944,34.768,159.256,38.206,164.789,40.272" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M68.567,186.672
	c0,3.314-11.568,10.215-11.568,10.215" />
                    <path fill="none" stroke="#000000" stroke-width="4" stroke-miterlimit="10" d="M133.367,190.271c0,2.867-10,6.615-13.709,7.822" />
                    <animateMotion path="M 10 10 H 300 Z" dur="3s" repeatCount="indefinite" />
                </g>

            </svg>

            <div class="sidebar">
                <div class="chatContainer">
                    <div class="chatHeader">
                        <span class="glyphicon glyphicon-comment chatSymbol" aria-hidden="true"></span><span style="padding-right:30px">Online Chat Room</span>
                        <span class="glyphicon glyphicon-user userSymbol" aria-hidden="true" onclick="cat();"></span>
                    </div>

                    <div id="chat" class="table-bordered chat"></div>
                    <div class="online" style="margin-top:10px;">
                        <span class="onlineHeader">Online Players:</span>
                        <div id="onlineList" class="table-bordered presence"></div>
                    </div>


                    <textarea class="message" placeholder="Enter your message here" id="message" cols="40" rows="2" onkeypress="sendingMessage(event);"></textarea>
                    <div class="chatButtons">
                        <button id="sendMessage" class="btn btn-primary send"><span class="glyphicon glyphicon-send" aria-hidden="true"></span>Send</button>
                        <button id="quitGame" class="btn btn-danger quit" onclick="quitGame();"><span class="glyphicon glyphicon-off" aria-hidden="true"></span>Quit Game</button>
                    </div>
                </div>
            </div>


        </div>
        <div id="chart" class="chart" style="display:none"></div>
    </div>
    </div>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1','packages':['corechart']}]}"></script>
    <script src="chart.js"></script>
    <script>
        var userAnswer;
        var answer = ['A'];
        var totalPoints = [];
        var currentPoints = 0;
        var roundNumber = 0;

        $(function () {
            var questions = [];
            counter = 1;
            $.getJSON('questions.json', function (data) {
                $.each(data.questions, function (i, f) {
                    var tblRow = "<div " + "id= '" + counter + "' style='display:none'>" + "Question: " + f.question + "<br />" + "A. " + f.answerA + " B. " + f.answerB + " " +
                        "C. " + f.answerC + " " + "D. " + f.answerD + " " + "</div>";
                    answer.splice(counter, 0, f.answer);
                    $(tblRow).prependTo("#questions");
                    counter++;
                });
            });
        });

        var currentQuestionId;

        function getQuestion() {
            $("#questions div").css({
                "display": "none"
            });
            currentQuestionId = Math.floor((Math.random() * 4) + 1);
            $('#' + currentQuestionId).css({
                "display": "block"
            });
        }

        function checkAnswer() {

            roundNumber++;
            if (userAnswer === answer[currentQuestionId]) {
                currentPoints += 5;
                totalPoints.splice(roundNumber, 0, currentPoints);
                document.getElementById("bulletin").innerHTML = "Score: " + currentPoints;
            } else {
                totalPoints.splice(roundNumber, 0, currentPoints);
                document.getElementById("bulletin").innerHTML = "Sorry, Try Again!";

            }
        }

        var myPathA;
        var snapA = Snap("#game");
        var path3 = "M325 425 C 430 200, 475 120, 450 50";
        var path1 = "M325 425 C 430 200, 475 120, 100 50";
        var path4 = "M325 425 C 430 200, 475 120, 375 150";
        var path2 = "M325 425 C 430 200, 475 120, 175 150";


        $("#targetCot circle").click(function () { //picks path to travel and selects the user's answer from the list of multiple choice questions
            var targetId = $(this).attr("id").toString();
            if (targetId === "targeta") {
                pathId = path1;
                userAnswer = 'A';
            } else if (targetId === "targetb") {
                pathId = path2;
                userAnswer = 'B';
            } else if (targetId === "targetc") {
                pathId = path3;
                userAnswer = 'C';
            } else if (targetId === "targetd") {
                pathId = path4;
                userAnswer = 'D';
            }
            checkAnswer();
            myPathA = snapA.path(pathId).attr({
                id: "ballpath",
                fill: "none",
                strokeWidth: "0",
                stroke: "#ffffff",
                strokeMiterLimit: "10",
                strokeDasharray: "9 9",
                strokeDashOffset: "988.01"
            });
            var len = myPathA.getTotalLength();
            Snap.animate(0, len, function (value) {
                movePoint = myPathA.getPointAtLength(value);
                ball.attr({
                    cx: movePoint.x,
                    cy: movePoint.y
                }); // move along path via cx & cy attributes
            }, 1000, mina.easeinout, targethit);

        });



        var ball = snapA.circle(325, 425, 20);
        ball.attr({
            fill: "#165788",
            stroke: "#fff",
            strokeWidth: 2,
        });

        (function () {
            channel = "test"; //channel to communicate with
            channelTest = "answerTest";

            var username = window.location.search.substring(1).split("=")[1]; //get the user name by parsing window location data
            //<span class="glyphicon glyphicon-user" aria-hidden="true"></span>
            var pic = ' <span class="glyphicon glyphicon-ok-circle" aria-hidden="true" style="color:#2ecc71"></span>';
            var list = $('#onlineList')[0].innerHTML; //stores active online players
            pubnub = PUBNUB.init({
                //keys and usernames 
                publish_key: "pub-c-c5075824-af73-4801-bd99-ad8485f4301c",
                subscribe_key: "sub-c-316e7e30-7cf9-11e4-baaa-02ee2ddab7fe",
                uuid: username
            });
            pubnub.subscribe({
                channel: channel,
                callback: function (message) { //displays the message on the message board
                    $("#chat")[0].innerHTML = $("#chat")[0].innerHTML + "<br/>" + message; //Chat history is a table, have the message on the first line of that table
                },
                presence: function (state) {
                    if (state.action == 'join') {
                        if ($('#onlineList').text().indexOf(state.uuid) == -1) {
                            $('#onlineList')[0].innerHTML = pic + state.uuid + '<br/>' + $('#onlineList')[0].innerHTML;
                        }
                    } else {
                        var index = $('#onlineList')[0].innerHTML.indexOf(state.uuid);
                        if (index !== -1) {
                            $('#onlineList')[0].innerHTML =
                                $('#onlineList')[0].innerHTML.substring(0, index) +
                                $('#onlineList')[0].innerHTML.substring(index + state.uuid.length + 4);
                        }
                    }
                }
            });

            pubnub.bind("click", pubnub.$("sendMessage"), function (e) {
                pubnub.publish({
                    channel: channel,
                    message: pubnub.get_uuid() + ": " + $("#message").val() //send the content in the message box to server. In format: <username>:<message>
                });
                $("#message").val(""); //Set the default value of the message box after sending previous message
            });


            // For the Answers, Use a different channel and detect when targets have been clicked ********************************************************************************************************
            pubnub.subscribe({
                channel: channelTest,
                callback: function (message) { //displays the message on the message board
                    console.log(message); //Chat history is a table, have the message on the first line of that table
                }
            });

            //find a smart way to bind all 4 clicks into one function; workaround: have four seperate functions [Future Expansion]

            pubnub.bind("click", pubnub.$("targeta"), function (e) {
                var d = new Date();
                var n = d.getTime();
                pubnub.publish({
                    channel: channelTest,
                    message: pubnub.get_uuid() + " time: " + n
                });
            });

            pubnub.bind("click", pubnub.$("targetb"), function (e) {
                var d = new Date();
                var n = d.getTime();
                pubnub.publish({
                    channel: channelTest,
                    message: pubnub.get_uuid() + " time: " + n
                });
            });

            pubnub.bind("click", pubnub.$("targetc"), function (e) {
                var d = new Date();
                var n = d.getTime();
                pubnub.publish({
                    channel: channelTest,
                    message: pubnub.get_uuid() + " time: " + n
                });
            });

            pubnub.bind("click", pubnub.$("targetd"), function (e) {
                var d = new Date();
                var n = d.getTime();
                pubnub.publish({
                    channel: channelTest,
                    message: pubnub.get_uuid() + " time: " + n
                });
            });
            //*********************************************************************************************************************************************************************************************

        })();

        function targethit() {
            setTimeout(function () {
                ball.remove();
                ball = snapA.circle(325, 425, 20);
                ball.attr({
                    fill: "#165788",
                    stroke: "#fff",
                    strokeWidth: 2,
                });

            }, 100)

        }

        function sendingMessage(event) {
            if (event.which == 13 || event.keyCode == 13) {
                $("#sendMessage").click();
            }
        }

        function quitGame() { //unsubscribe and leave the chat room (quit game)
            pubnub.unsubscribe({
                channel: channel,
                callback: function () {
                    window.location = "login.html";
                }
            });
        }

        function startClicked() {
            getQuestion();
            document.getElementById("bulletin").innerHTML = "Ready...";
        }

        var toggle = 1;

        function stats() {
            if (toggle == 1) {
                $("#chart").css({
                    "display": "block"
                });
                drawChart();
            } else {
                $("#chart").css({
                    "display": "none"
                });
            }
            toggle = toggle * -1;

        }

        window.setInterval(function () {
            var elem = document.getElementById('chat');
            elem.scrollTop = elem.scrollHeight;
        }, 1);
    </script>
</body>


</html>